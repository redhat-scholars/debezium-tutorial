<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Debezium with Kafka Connect :: Debezium Tutorial</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/debezium-tutorial/debezium-tutorial/20-dbz-kafka-connect.html">
    <link rel="prev" href="10-introduction.html">
    <link rel="next" href="21-dbz-server.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io/debezium-tutorial">Debezium Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="debezium-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">1. Getting Started</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="10-introduction.html">Overview</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-introduction.html#cdc-concept">Change Data Capture</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-introduction.html#db-support">Supported Databases</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-introduction.html#deployment-modes">Deployment Modes</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">2. Elementary</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="20-dbz-kafka-connect.html">Apache Kafka Connect</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="21-dbz-server.html">Debezium Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="22-dbz-ui.html">Debezium UI</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Debezium Tutorial</a></li>
    <li>2. Elementary</li>
    <li><a href="20-dbz-kafka-connect.html">Apache Kafka Connect</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/debezium-tutorial/edit/master/documentation/modules/ROOT/pages/20-dbz-kafka-connect.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Debezium with Kafka Connect</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Debezium is often deployed in the context of Apache Kafka and Kafka Connect.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/dbz-connect-deployment.png" alt="Debezium Deployment Mode with Kafka Connect">
</div>
</div>
<div class="paragraph">
<p>The following exercise shows and explains how to configure a Debezium Source Connector for postgreSQL. The resulting CDC pipeline will capture all data change events that are occurring in a postgreSQL database table and propagate these changes into an Apache Kafka topic. The following illustration shows the overview and data flow of the demo scenario.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/dbz-tutorial-elementary-kafka-connect-example-basic.png" alt="Debezium with Kafka Connect Demo Scenario">
</div>
</div>
<div class="paragraph">
<p>For the example all required data infrastructure components are run as containers locally, either with Podman or Docker. <strong>It&#8217;s important to note, that all containers are configured as <em>single ephemeral instances</em> which means that all state and data is lost after shutting them down!</strong></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_start_required_services_as_containers"><a class="anchor" href="#_start_required_services_as_containers"></a>Start required services as containers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Launch the following 4 containers each in its separate terminal window. This will allow to easily inspect their respective logs individually while working through the demo scenario step-by-step.</p>
</div>
<div class="sect2">
<h3 id="_1_zookeeper"><a class="anchor" href="#_1_zookeeper"></a>1. Zookeeper</h3>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_podman"></a>Podman</p>
</li>
<li>
<p><a id="tabset1_docker"></a>Docker</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_podman">
<div class="paragraph">
<p>First, let&#8217;s start 1 pod which will host all containers needed for this demo scenario.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">podman pod create --name=dbz -p 9092:9092 -p 8083:8083 -p 5432:5432</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then run the Zookeeper container in this pod as follows</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">podman run -it --rm --name zookeeper --pod dbz quay.io/debezium/zookeeper:2.2.0.Final</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_docker">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">docker run -it --rm --name zookeeper -p 2181:2181 -p 2888:2888 -p 3888:3888 quay.io/debezium/zookeeper:2.2.0.Final</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_kafka"><a class="anchor" href="#_2_kafka"></a>2. Kafka</h3>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_podman"></a>Podman</p>
</li>
<li>
<p><a id="tabset2_docker"></a>Docker</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_podman">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">podman run -it --rm --name kafka --pod dbz quay.io/debezium/kafka:2.2.0.Final</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_docker">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">docker run -it --rm --name kafka -p 9092:9092 --link zookeeper:zookeeper quay.io/debezium/kafka:2.2.0.Final</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_3_postgresql"><a class="anchor" href="#_3_postgresql"></a>3. postgreSQL</h3>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_podman"></a>Podman</p>
</li>
<li>
<p><a id="tabset3_docker"></a>Docker</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_podman">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">podman run -it --rm --name postgres --pod dbz -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=postgres quay.io/debezium/example-postgres:2.2.0.Final</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_docker">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">docker run -it --rm --name postgres -p 5432:5432 -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=postgres quay.io/debezium/example-postgres:2.2.0.Final</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_kafka_connect"><a class="anchor" href="#_4_kafka_connect"></a>4. Kafka Connect</h3>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_podman"></a>Podman</p>
</li>
<li>
<p><a id="tabset4_docker"></a>Docker</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_podman">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">podman run -it --rm --name connect --pod dbz -e GROUP_ID=1 -e CONFIG_STORAGE_TOPIC=my_connect_configs -e OFFSET_STORAGE_TOPIC=my_connect_offsets -e STATUS_STORAGE_TOPIC=my_connect_statuses quay.io/debezium/connect:2.2.0.Final</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset4_docker">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">docker run -it --rm --name connect -p 8083:8083 -e GROUP_ID=1 -e CONFIG_STORAGE_TOPIC=my_connect_configs -e OFFSET_STORAGE_TOPIC=my_connect_offsets -e STATUS_STORAGE_TOPIC=my_connect_statuses --link kafka:kafka --link postgres:postgres quay.io/debezium/connect:2.2.0.Final</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_check_the_database_and_kafka_connect"><a class="anchor" href="#_check_the_database_and_kafka_connect"></a>Check the database and Kafka Connect</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_run_pg_cli_and_inspect_the_sample_database_table"><a class="anchor" href="#_1_run_pg_cli_and_inspect_the_sample_database_table"></a>1. Run pg CLI and inspect the sample database table</h3>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset5_podman"></a>Podman</p>
</li>
<li>
<p><a id="tabset5_docker"></a>Docker</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset5_podman">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">#exec into the db container's bash
podman exec -it postgres bash

#in the container's bash start pg cli
psql -h localhost -p 5432 -U postgres postgres

#run this query in the pg cli to show all customer records
SELECT * FROM inventory.customers;</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">  id  | first_name | last_name |         email
------+------------+-----------+-----------------------
 1001 | Sally      | Thomas    | sally.thomas@acme.com
 1002 | George     | Bailey    | gbailey@foobar.com
 1003 | Edward     | Walker    | ed@walker.com
 1004 | Anne       | Kretchmar | annek@noanswer.org
(4 rows)</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset5_docker">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">#exec into the db container's bash
docker exec -it postgres bash

#in the container's bash start pg cli
psql -h localhost -p 5432 -U postgres postgres

#run this query in the pg cli to show all customer records
SELECT * FROM inventory.customers;</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">  id  | first_name | last_name |         email
------+------------+-----------+-----------------------
 1001 | Sally      | Thomas    | sally.thomas@acme.com
 1002 | George     | Bailey    | gbailey@foobar.com
 1003 | Edward     | Walker    | ed@walker.com
 1004 | Anne       | Kretchmar | annek@noanswer.org
(4 rows)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The terminal which is running the pg CLI session should be kept open for later use!</p>
</div>
</div>
<div class="sect2">
<h3 id="_2_check_kafka_connect_rest_api"><a class="anchor" href="#_2_check_kafka_connect_rest_api"></a>2. Check Kafka Connect REST API</h3>
<div class="paragraph">
<p>In a separate terminal window make the following two HTTP calls against the Kafka Connect REST API endpoints to make sure everything is up and running fine.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">curl -H "Accept:application/json" localhost:8083/</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">{"version":"3.4.0","commit":"2e1947d240607d53","kafka_cluster_id":"BCez9UHGS-eBpmZ8eBZd6g"}</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">curl -H "Accept:application/json" localhost:8083/connectors/</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">[]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_run_debezium_source_connector"><a class="anchor" href="#_run_debezium_source_connector"></a>Run Debezium Source Connector</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_register_debezium_postgresql_source_connector"><a class="anchor" href="#_1_register_debezium_postgresql_source_connector"></a>1. Register Debezium postgreSQL source connector</h3>
<div class="paragraph">
<p>The following configuration instructs Kafka Connect to instantiate the Debezium postgreSQL source connector. Based on the settings it will take a snapshot and then keeps listening to any changes occurring in the <code>inventory.customers</code> table. To keep things simple for now, all CDC events will be JSON encoded without any schema information attached.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "name": "inventory-connector",
  "config": {
    "connector.class": "io.debezium.connector.postgresql.PostgresConnector",
    "key.converter": "org.apache.kafka.connect.json.JsonConverter",
    "key.converter.schemas.enable":false,
    "value.converter": "org.apache.kafka.connect.json.JsonConverter",
    "value.converter.schemas.enable":false,
    "tasks.max": "1",
    "database.hostname": "postgres",
    "database.port": "5432",
    "database.user": "postgres",
    "database.password": "postgres",
    "database.dbname": "postgres",
    "topic.prefix": "dbserver1",
    "schema.include.list": "inventory",
    "table.include.list": "inventory.customers"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s run this configuration against the Kafka Connect REST API endpoint by sending a POST request.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">curl -i -X POST -H "Accept:application/json" -H "Content-Type:application/json" localhost:8083/connectors/ -d '{ "name": "inventory-connector", "config": { "connector.class": "io.debezium.connector.postgresql.PostgresConnector", "key.converter": "org.apache.kafka.connect.json.JsonConverter", "key.converter.schemas.enable":false, "value.converter": "org.apache.kafka.connect.json.JsonConverter", "value.converter.schemas.enable":false, "tasks.max": "1", "database.hostname": "postgres", "database.port": "5432", "database.user": "postgres", "database.password": "postgres", "database.dbname" : "postgres", "topic.prefix": "dbserver1", "schema.include.list": "inventory", "table.include.list": "inventory.customers" } }'</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">HTTP/1.1 201 Created
Date: Wed, 14 Jun 2023 07:29:07 GMT
Location: http://localhost:8083/connectors/inventory-connector
Content-Type: application/json
Content-Length: 635
Server: Jetty(9.4.48.v20220622)

{"name":"inventory-connector","config":{"connector.class":"io.debezium.connector.postgresql.PostgresConnector","key.converter":"org.apache.kafka.connect.json.JsonConverter","key.converter.schemas.enable":"false","value.converter":"org.apache.kafka.connect.json.JsonConverter","value.converter.schemas.enable":"false","tasks.max":"1","database.hostname":"postgres","database.port":"5432","database.user":"postgres","database.password":"postgres","database.dbname":"postgres","topic.prefix":"dbserver1","schema.include.list":"inventory","table.include.list":"inventory.customers","name":"inventory-connector"},"tasks":[],"type":"source"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sending a GET request against the <code>status</code> REST API endpoint of this specific connector should show that the connector and 1 task is in <code>RUNNING</code> state and thus working fine.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">curl -i -X GET -H "Accept:application/json" localhost:8083/connectors/inventory-connector/status</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">HTTP/1.1 200 OK
Date: Wed, 14 Jun 2023 07:16:38 GMT
Content-Type: application/json
Content-Length: 175
Server: Jetty(9.4.48.v20220622)

{"name":"inventory-connector","connector":{"state":"RUNNING","worker_id":"172.17.0.5:8083"},"tasks":[{"id":0,"state":"RUNNING","worker_id":"172.17.0.5:8083"}],"type":"source"}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_view_cdc_events_in_kafka_topic"><a class="anchor" href="#_2_view_cdc_events_in_kafka_topic"></a>2. View CDC events in Kafka topic</h3>
<div class="paragraph">
<p>The source connector produced all CDC events captured for the configured postgreSQL table into a corresponding Apache Kafka topic which in this case was named <code>dbserver1.inventory.customers</code>. Let&#8217;s run a container process to consume form this topic and keep listening for future CDC events like so:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset6_podman"></a>Podman</p>
</li>
<li>
<p><a id="tabset6_docker"></a>Docker</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset6_podman">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">podman run -it --rm --name watcher --pod dbz quay.io/debezium/kafka:2.2.0.Final watch-topic -a -k dbserver1.inventory.customers</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset6_docker">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">docker run -it --rm --name watcher --link zookeeper:zookeeper --link kafka:kafka quay.io/debezium/kafka:2.2.0.Final watch-topic -a -k dbserver1.inventory.customers</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">{"id":1001}	{"before":null,"after":{"id":1001,"first_name":"Sally","last_name":"Thomas","email":"sally.thomas@acme.com"},"source":{"version":"2.0.1.Final","connector":"postgresql","name":"dbserver1","ts_ms":1686727747318,"snapshot":"first","db":"postgres","sequence":"[null,\"34487680\"]","schema":"inventory","table":"customers","txId":768,"lsn":34487680,"xmin":null},"op":"r","ts_ms":1686727747354,"transaction":null}
{"id":1002}	{"before":null,"after":{"id":1002,"first_name":"George","last_name":"Bailey","email":"gbailey@foobar.com"},"source":{"version":"2.0.1.Final","connector":"postgresql","name":"dbserver1","ts_ms":1686727747318,"snapshot":"true","db":"postgres","sequence":"[null,\"34487680\"]","schema":"inventory","table":"customers","txId":768,"lsn":34487680,"xmin":null},"op":"r","ts_ms":1686727747356,"transaction":null}
{"id":1003}	{"before":null,"after":{"id":1003,"first_name":"Edward","last_name":"Walker","email":"ed@walker.com"},"source":{"version":"2.0.1.Final","connector":"postgresql","name":"dbserver1","ts_ms":1686727747318,"snapshot":"true","db":"postgres","sequence":"[null,\"34487680\"]","schema":"inventory","table":"customers","txId":768,"lsn":34487680,"xmin":null},"op":"r","ts_ms":1686727747356,"transaction":null}
{"id":1004}	{"before":null,"after":{"id":1004,"first_name":"Anne","last_name":"Kretchmar","email":"annek@noanswer.org"},"source":{"version":"2.0.1.Final","connector":"postgresql","name":"dbserver1","ts_ms":1686727747318,"snapshot":"last","db":"postgres","sequence":"[null,\"34487680\"]","schema":"inventory","table":"customers","txId":768,"lsn":34487680,"xmin":null},"op":"r","ts_ms":1686727747356,"transaction":null}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The console output shows all 4 database table rows have been captured by the initial snapshot that the Debezium source connector performed. Each CDC event is represented with one Kafka record composed of the <code>key</code> and <code>value</code> parts. Let&#8217;s inspect the last of the 4 CDC events in detail:</p>
</div>
<div class="paragraph">
<p><strong>Key: </strong>All it contains is the tables primary key column(s) (<code>id</code>) its actual PK value(s).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{"id":1004}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Value: </strong>The value part is more verbose because, besides the actual row values it also contains a bunch of meta-data related to the change event. The <code>before</code> field is <code>null</code> because for an initial snapshot event (<code>"op":"r"</code>) there is no previous state to expose. The <code>after</code> field in this case contains the table row&#8217;s column data as it was during the time the snapshot was taken.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "before": null,
  "after": {
    "id": 1004,
    "first_name": "Anne",
    "last_name": "Kretchmar",
    "email": "annek@noanswer.org"
  },
  "source": {
    "version": "2.0.1.Final",
    "connector": "postgresql",
    "name": "dbserver1",
    "ts_ms": 1686727747318,
    "snapshot": "last",
    "db": "postgres",
    "sequence": "[null,\"34487680\"]",
    "schema": "inventory",
    "table": "customers",
    "txId": 768,
    "lsn": 34487680,
    "xmin": null
  },
  "op": "r",
  "ts_ms": 1686727747356,
  "transaction": null
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_3_run_update_statement_and_inspect_cdc_events"><a class="anchor" href="#_3_run_update_statement_and_inspect_cdc_events"></a>3. Run update statement and inspect CDC events</h3>
<div class="paragraph">
<p>Switch back to the terminal window running the pg CLI and run a SQL <code>UPDATE</code> statement, followed by a <code>SELECT</code> to verify the change:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">UPDATE inventory.customers SET first_name='Anne Marie' WHERE id=1004;

SELECT * FROM inventory.customers;</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">UPDATE 1
  id  | first_name | last_name |         email
------+------------+-----------+-----------------------
 1001 | Sally      | Thomas    | sally.thomas@acme.com
 1002 | George     | Bailey    | gbailey@foobar.com
 1003 | Edward     | Walker    | ed@walker.com
 1004 | Anne Marie | Kretchmar | annek@noanswer.org
(4 rows)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switch over to the "watcher" terminal window to see that the kafka topic in question did receive this captured data change event:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">{"id":1004} {"before":{"id":1004,"first_name":"Anne","last_name":"Kretchmar","email":"annek@noanswer.org"},"after":{"id":1004,"first_name":"Anne Marie","last_name":"Kretchmar","email":"annek@noanswer.org"},"source":{"version":"2.0.1.Final","connector":"postgresql","name":"dbserver1","ts_ms":1686729166190,"snapshot":"false","db":"postgres","sequence":"[null,\"34488008\"]","schema":"inventory","table":"customers","txId":769,"lsn":34488008,"xmin":null},"op":"u","ts_ms":1686729166517,"transaction":null}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s take a closer look at the Kafka record&#8217;s value part for this CDC event. The main difference here is that we are dealing with an update event (<code>"op":"u"</code>). For update events we now have both fields set:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>before</code>: contains the database table&#8217;s row values as they were before the modification</p>
</li>
<li>
<p><code>after</code>: contains the database table&#8217;s row values as they are now after the modification</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "before": {
    "id": 1004,
    "first_name": "Anne",
    "last_name": "Kretchmar",
    "email": "annek@noanswer.org"
  },
  "after": {
    "id": 1004,
    "first_name": "Anne Marie",
    "last_name": "Kretchmar",
    "email": "annek@noanswer.org"
  },
  "source": {
    "version": "2.0.1.Final",
    "connector": "postgresql",
    "name": "dbserver1",
    "ts_ms": 1686729166190,
    "snapshot": "false",
    "db": "postgres",
    "sequence": "[null,\"34488008\"]",
    "schema": "inventory",
    "table": "customers",
    "txId": 769,
    "lsn": 34488008,
    "xmin": null
  },
  "op": "u",
  "ts_ms": 1686729166517,
  "transaction": null
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_run_delete_statement_and_inspect_cdc_events"><a class="anchor" href="#_4_run_delete_statement_and_inspect_cdc_events"></a>4. Run delete statement and inspect CDC events</h3>
<div class="paragraph">
<p>Switch back to the terminal window running the pg CLI and run a SQL <code>DELETE</code> statement, followed by a <code>SELECT</code> to verify the deletion:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">DELETE FROM inventory.customers WHERE id=1004;

SELECT * FROM inventory.customers;</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">DELETE 1
  id  | first_name | last_name |         email
------+------------+-----------+-----------------------
 1001 | Sally      | Thomas    | sally.thomas@acme.com
 1002 | George     | Bailey    | gbailey@foobar.com
 1003 | Edward     | Walker    | ed@walker.com
(3 rows)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
in case you use a different <code>id</code> than <code>1004</code>, this may result in a foreign key constraint violation. Either you go with the suggested <code>1004</code> or you&#8217;d need to delete other records beforehand which reference the specific record and hence violate the key constraint.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When deleting a row from the <code>inventory.customers</code> table, the Debezium source connector actually generated two new events. The "main" CDC event reflecting the deletion operation plus an additional so-called "tombstone" event. Switch over to the "watcher" terminal window to verify this:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">{"id":1004} {"before":{"id":1004,"first_name":"Anne Marie","last_name":"Kretchmar","email":"annek@noanswer.org"},"after":null,"source":{"version":"2.0.1.Final","connector":"postgresql","name":"dbserver1","ts_ms":1686729872614,"snapshot":"false","db":"postgres","sequence":"[\"34488608\",\"34488896\"]","schema":"inventory","table":"customers","txId":770,"lsn":34488896,"xmin":null},"op":"d","ts_ms":1686729873091,"transaction":null}
{"id":1004} null</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>CDC event record value: </strong>Since we are dealing with a deletion operation (<code>"op":"d"</code>), there is only the <code>before</code> field set which contains the table&#8217;s row values before the deletion happened. The <code>after</code> field is <code>null</code> in this case, as the data has been removed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "before": {
    "id": 1004,
    "first_name": "Anne Marie",
    "last_name": "Kretchmar",
    "email": "annek@noanswer.org"
  },
  "after": null,
  "source": {
    "version": "2.0.1.Final",
    "connector": "postgresql",
    "name": "dbserver1",
    "ts_ms": 1686729872614,
    "snapshot": "false",
    "db": "postgres",
    "sequence": "[\"34488608\",\"34488896\"]",
    "schema": "inventory",
    "table": "customers",
    "txId": 770,
    "lsn": 34488896,
    "xmin": null
  },
  "op": "d",
  "ts_ms": 1686729873091,
  "transaction": null
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Tombstone event: </strong>the value part of the Kafka record is just <code>null</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{"id":1004} null</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
While sending an additional tombstone event can be omitted by configuration the default behaviour of Debezium source connectors is to emit them. Tombstones allow Kafka to completely delete all events that refer to the same key of the deleted row in case log compaction is enabled for the corresponding Kafka topic.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_verify_resilience_due_to_kafka_connect_downtime"><a class="anchor" href="#_verify_resilience_due_to_kafka_connect_downtime"></a>Verify resilience due to Kafka Connect downtime</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_stop_kafka_connect"><a class="anchor" href="#_1_stop_kafka_connect"></a>1. Stop Kafka Connect</h3>
<div class="paragraph">
<p>Let&#8217;s "simulate" a Kafka Connect downtime by purposefully shutting down the containerized service.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset7_podman"></a>Podman</p>
</li>
<li>
<p><a id="tabset7_docker"></a>Docker</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset7_podman">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">podman stop connect</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">connect</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset7_docker">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">docker stop connect</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">connect</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_perform_databases_changes_during_downtime"><a class="anchor" href="#_2_perform_databases_changes_during_downtime"></a>2. Perform databases changes during downtime</h3>
<div class="paragraph">
<p>During the downtime of Kafka Connect there is obviously also no activity by the Debezium source connector which isn&#8217;t running at the moment. Switch back to the terminal window running the pg CLI and exectue two <code>INSERT</code> statements followed by the <code>SELECT</code> query to see the two new rows:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">INSERT INTO inventory.customers VALUES (default,'Sarah', 'Thompson', 'kitt@acme.com');
INSERT INTO inventory.customers VALUES (default,'Kenneth', 'Anderson', 'kander@acme.com');

SELECT * FROM inventory.customers;</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">INSERT 0 1
INSERT 0 1
  id  | first_name | last_name |         email
------+------------+-----------+-----------------------
 1001 | Sally      | Thomas    | sally.thomas@acme.com
 1002 | George     | Bailey    | gbailey@foobar.com
 1003 | Edward     | Walker    | ed@walker.com
 1005 | Sarah      | Thompson  | kitt@acme.com
 1006 | Kenneth    | Anderson  | kander@acme.com
(5 rows)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_3_restart_kafka_connect"><a class="anchor" href="#_3_restart_kafka_connect"></a>3. Restart Kafka Connect</h3>
<div class="paragraph">
<p>Let&#8217;s now restart Kafka Connect with same options there were initially used to run it.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset8_podman"></a>Podman</p>
</li>
<li>
<p><a id="tabset8_docker"></a>Docker</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset8_podman">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">podman run -it --rm --name connect --pod dbz -e GROUP_ID=1 -e CONFIG_STORAGE_TOPIC=my_connect_configs -e OFFSET_STORAGE_TOPIC=my_connect_offsets -e STATUS_STORAGE_TOPIC=my_connect_statuses quay.io/debezium/connect:2.2.0.Final</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset8_docker">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">docker run -it --rm --name connect -p 8083:8083 -e GROUP_ID=1 -e CONFIG_STORAGE_TOPIC=my_connect_configs -e OFFSET_STORAGE_TOPIC=my_connect_offsets -e STATUS_STORAGE_TOPIC=my_connect_statuses --link zookeeper:zookeeper --link kafka:kafka --link postgres:postgres quay.io/debezium/connect:2.2.0.Final</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_view_cdc_events_in_kafka_topic"><a class="anchor" href="#_4_view_cdc_events_in_kafka_topic"></a>4. View CDC events in Kafka topic</h3>
<div class="paragraph">
<p>Switch over to the "watcher" terminal window to see that the kafka topic in question did receive this captured data change events after Kafka Connect and the configured Debezium source connector were up and running again:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">{"id":1005} {"before":null,"after":{"id":1005,"first_name":"Sarah","last_name":"Thompson","email":"kitt@acme.com"},"source":{"version":"2.0.1.Final","connector":"postgresql","name":"dbserver1","ts_ms":1686732230489,"snapshot":"false","db":"postgres","sequence":"[\"34489480\",\"34489816\"]","schema":"inventory","table":"customers","txId":771,"lsn":34489816,"xmin":null},"op":"c","ts_ms":1686732629473,"transaction":null}
{"id":1006} {"before":null,"after":{"id":1006,"first_name":"Kenneth","last_name":"Anderson","email":"kander@acme.com"},"source":{"version":"2.0.1.Final","connector":"postgresql","name":"dbserver1","ts_ms":1686732230493,"snapshot":"false","db":"postgres","sequence":"[\"34490856\",\"34490856\"]","schema":"inventory","table":"customers","txId":772,"lsn":34490856,"xmin":null},"op":"c","ts_ms":1686732629475,"transaction":null}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clean_up"><a class="anchor" href="#_clean_up"></a>Clean up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s remove all data infrastructure components for this demo scenario by stopping all related containers.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset9_podman"></a>Podman</p>
</li>
<li>
<p><a id="tabset9_docker"></a>Docker</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset9_podman">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">podman pod rm -f dbz</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">#YOUR DELETED POD's ID HERE e.g.
a94642f7b74edb020a7e0a6142e844c94c46d7320a8a69fe5d17c8c9b1c22020</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset9_docker">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">docker stop connect watcher postgres kafka zookeeper</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-adoc hljs" data-lang="adoc">connect
watcher
postgres
kafka
zookeeper</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>ðŸŽ‰ <strong>Congrats on building your first change data capture pipeline with Debezium and Kafka!</strong> ðŸŽŠ</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="10-introduction.html">Overview</a></span>
  <span class="next"><a href="21-dbz-server.html">Debezium Server</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
